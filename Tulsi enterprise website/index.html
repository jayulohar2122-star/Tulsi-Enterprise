<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' https://via.placeholder.com https://*.google.com https://*.googleapis.com https://*.gstatic.com;">
<title>Tulsi Enterprise</title>
<style>
/* --- ORIGINAL RED THEME RESTORED --- */
:root {
  --bg: #f4f6f8;          /* Original Background */
  --card: #ffffff;
  --accent: #bd1b1b;      /* Original Red Accent */
  --accent-hover: #a51616;
  --muted: #6b7280;
  --radius: 12px;
  --max-width: 1200px;
  font-family: Inter, system-ui, -apple-system, 'Segoe UI', Roboto, Arial;
  color: #111827;
}

* { box-sizing: border-box; }

html { scroll-behavior: smooth; }

body {
  margin: 0;
  background: var(--bg);
  display: flex;
  justify-content: center;
  padding: 24px 24px 90px 24px;
}

.site { width: 100%; max-width: var(--max-width); }

/* --- HEADER (Red Gradient) --- */
header.site-header {
    display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; padding: 18px;
    border-radius: 14px;
    background: linear-gradient(90deg, var(--accent), #ff6b6b); /* Original Red Gradient */
    color: #fff;
    box-shadow: 0 12px 30px rgba(0,0,0,0.12);
    transition: transform 0.3s ease;
}
header.site-header:hover { transform: translateY(-2px); }

.brand-left { display: flex; gap: 14px; align-items: center; }
.brand-left img.logo { width: 72px; height: 72px; border-radius: 10px; object-fit: cover; border: 2px solid rgba(255,255,255,0.12); }
.brand-info { line-height: 1.2; text-align: left; }
.brand-name { font-size: 20px; font-weight: 800; letter-spacing: 0.6px; }
.brand-tag { font-size: 13px; opacity: 0.95; }

nav.header-nav { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
nav.header-nav a {
    color: rgba(255,255,255,0.95); text-decoration: none; font-weight: 700; padding: 8px 12px; border-radius: 8px;
    transition: all 0.3s ease;
}
nav.header-nav a:hover { background: rgba(255,255,255,0.2); transform: scale(1.05); }

/* --- HERO SECTION --- */
.hero { display: flex; gap: 20px; align-items: center; margin: 22px 0; flex-wrap: wrap; }
.hero .text { flex: 1; min-width: 200px; }
.hero h1 { margin: 0; font-size: 30px; }
.hero p { margin: 8px 0; color: var(--muted); }
.hero h4 { margin-top: 12px; color: #333; }

/* CATEGORIES */
.hero-categories { margin-top: 15px; font-weight: 700; font-size: 16px; line-height: 1.6; color: #333; }
.cat-link { cursor: pointer; transition: all 0.3s ease; border-bottom: 2px solid transparent; display: inline-block; }
.cat-link:hover { color: var(--accent); border-bottom: 2px solid var(--accent); transform: translateY(-2px); }
.separator { color: #ccc; margin: 0 6px; }

/* CONTROLS */
.control-bar { display: flex; gap: 12px; align-items: center; margin-bottom: 14px; flex-wrap: wrap; }
.search { flex: 1; min-width: 200px; }

.search input, .select, .form-input, .feedback-text {
    width: 100%; padding: 10px 12px; border-radius: 10px; border: 1px solid #e6e6e9;
    transition: all 0.3s ease;
}
.search input:focus, .select:focus, .form-input:focus, .feedback-text:focus {
    outline: none;
    border-color: var(--accent);
    box-shadow: 0 0 0 4px rgba(189, 27, 27, 0.1); /* Red Glow */
}
.select { padding: 10px; border-radius: 10px; border: 1px solid #e6e6e9; background: #fff; }

/* --- PRODUCT GRID --- */
.products {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
  gap: 18px;
}

/* ANIMATIONS */
@keyframes fadeInUp {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

.product {
    background: var(--card); border-radius: var(--radius); padding: 12px;
    box-shadow: 0 8px 20px rgba(16,24,40,0.06);
    display: flex; flex-direction: column;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
    animation: fadeInUp 0.6s ease backwards;
}
.product:hover {
    transform: translateY(-10px) scale(1.02);
    box-shadow: 0 20px 40px rgba(189, 27, 27, 0.15); /* Red Shadow */
}

/* --- IMAGE UPDATE: 1024x1024 (SQUARE RATIO) --- */
.product .img {
    width: 100%;
    aspect-ratio: 1 / 1; /* Forces perfect square */
    height: auto;        /* Removes fixed height */
    border-radius: 10px;
    overflow: hidden; 
    margin-bottom: 10px;
    background: #f3f4f6;
}
.product .img img {
    width: 100%;
    height: 100%;
    object-fit: cover; 
    transition: transform 0.5s ease;
}
.product:hover .img img { transform: scale(1.1); } 

/* META INFO */
.p-meta { display: flex; flex-direction: column; gap: 6px; align-items: flex-start; }
.p-name { font-weight: 800; font-size: 16px; color: #111; }
.p-price { color: var(--accent); font-weight: 700; font-size: 15px; }
.p-sub {
    color: var(--muted); font-size: 11px; font-weight: 600;
    text-transform: uppercase; background: #f3f4f6; padding: 4px 8px;
    border-radius: 6px; letter-spacing: 0.5px;
}

/* BUTTONS */
.btn {
    flex: 1; padding: 10px; border-radius: 10px; text-align: center; font-weight: 800;
    cursor: pointer; border: 0; font-size: 14px; transition: all 0.2s ease;
}
.btn:active { transform: scale(0.95); }

.btn-order { background: var(--accent); color: #fff; box-shadow: 0 4px 6px rgba(189, 27, 27, 0.3); }
.btn-order:hover { background: #a51616; box-shadow: 0 6px 12px rgba(189, 27, 27, 0.4); }

.btn-details { background: transparent; border: 1px solid #e6e6e9; }
.btn-details:hover { background: #f3f4f6; }

/* CONTACT FOOTER */
.contact-bottom {
    margin-top: 22px; background: linear-gradient(180deg, rgba(255,255,255,0.9), #fff);
    padding: 16px; border-radius: 12px; display: grid; grid-template-columns: repeat(3, 1fr);
    gap: 10px; align-items: center;
}
.c-box h3 { margin: 0; font-size: 14px; }
.c-box p { margin: 6px 0 0 0; color: var(--muted); font-size: 13px; }
.c-box a { color: var(--accent); text-decoration: none; font-weight: 700; }

/* --- MODALS --- */
.modal {
    display: none; position: fixed; inset: 0; background: rgba(2, 6, 23, 0.6);
    z-index: 60; align-items: center; justify-content: center; padding: 20px;
    backdrop-filter: blur(4px);
}
.modal.open { display: flex; animation: fadeInModal 0.3s ease forwards; }

@keyframes fadeInModal { from { opacity: 0; } to { opacity: 1; } }

.modal-content {
    width: 100%; max-width: 720px; background: var(--card); border-radius: 12px;
    padding: 18px; display: grid; grid-template-columns: 1fr 1fr; gap: 12px;
    position: relative; transform: scale(0.8); opacity: 0;
    transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}
.modal.open .modal-content { transform: scale(1); opacity: 1; }

.modal-left img { width: 100%; height: 320px; object-fit: cover; border-radius: 10px; }
.modal-right h2 { margin: 0; font-size: 20px; }
.modal-right p { color: var(--muted); margin-top: 8px; }

.modal-actions { display: flex; gap: 10px; margin-top: 14px; flex-direction: column; }
.modal-actions select, .modal-actions input { padding: 8px; border-radius: 8px; border: 1px solid #e6e6e9; width: 100%; }

.modal .close {
    position: absolute; top: 18px; right: 18px; background: transparent;
    border: 0; font-size: 22px; color: #fff; cursor: pointer; transition: transform 0.2s;
}
.modal .close:hover { transform: rotate(90deg) scale(1.1); color: var(--accent); }

/* FEEDBACK & CONFIRM BOXES */
.feedback-box, .confirm-box {
    display: flex; flex-direction: column; align-items: center; text-align: center;
    width: 100%; max-width: 400px !important; grid-template-columns: 1fr !important;
}
.star-rating { display: flex; gap: 8px; margin: 15px 0; font-size: 32px; cursor: pointer; }
.star { color: #e6e6e9; transition: color 0.2s; transform: scale(1); }
.star:hover { transform: scale(1.2); }
.star.active { color: #ffd700; }

.feedback-btn {
    width: 100%; padding: 12px; background: var(--accent); color: white;
    font-weight: 700; border: none; border-radius: 8px; cursor: pointer; transition: 0.2s;
}
.feedback-btn:active { transform: scale(0.95); }

.confirm-details {
    background: #f8fafc; border: 1px solid #e2e8f0; padding: 15px;
    border-radius: 10px; width: 100%; text-align: left; margin: 10px 0 20px 0;
    font-size: 14px; line-height: 1.5;
}

/* MARQUEE */
.min-popup {
    position: fixed; bottom: 5px; left: 50%; transform: translateX(-50%);
    width: 95%; max-width: 800px; background: #bd1b1b; /* Original Red */
    color: #fff; padding: 10px 0; border-radius: 50px; font-weight: 800; font-size: 14px;
    box-shadow: 0 8px 20px rgba(0,0,0,0.2); z-index: 9999;
    overflow: hidden; white-space: nowrap; display: flex; align-items: center;
}
.marquee-content { display: inline-block; padding-left: 100%; animation: scroll-left 20s linear infinite; }
@keyframes scroll-left { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }

/* RESPONSIVE */
@media (max-width: 900px) {
    header.site-header { flex-direction: column; align-items: center; text-align: center; padding: 14px; }
    .brand-left { flex-direction: column; gap: 8px; align-items: center; }
    nav.header-nav { justify-content: center; width: 100%; margin-top: 10px; gap: 10px; }
}
@media (max-width: 800px) {
    .modal-content { grid-template-columns: 1fr; }
    .modal-left img { height: 220px; }
}
</style>
</head>
<body>
<div class="site">
<header class="site-header">
  <div class="brand-left">
    <img class="logo" src="te items/te logo.png" onerror="this.onerror=null;this.src='https://via.placeholder.com/150'">
    <div class="brand-info">
      <div class="brand-name">TULSI ENTERPRISE</div>
    </div>
  </div>
  <nav class="header-nav">
    <a href="#products">Products</a>
    <a href="#contact">About</a>
  </nav>
</header>
<section class="hero">
  <div class="text">
    <h1>Natural & Premium Agarbatti & Dhoop</h1>
    <p>Explore our best-selling incense sticks and dhoop.</p>
    
    <div class="hero-categories">
        <span class="cat-link" onclick="quickFilter('black-scented-agarbatti')">Black Scented Agarbatti</span><span class="separator">/</span>
        <span class="cat-link" onclick="quickFilter('white-scented-agarbatti')">White Scented Agarbatti</span><span class="separator">/</span>
        <span class="cat-link" onclick="quickFilter('row-agarbatti')">Row Agarbatti</span><span class="separator">/</span>
        <span class="cat-link" onclick="quickFilter('scented-dhoop')">Scented Dhoop</span><span class="separator">/</span>
        <span class="cat-link" onclick="quickFilter('row-dhoop')">Row Dhoop</span>
    </div>

    <h4>All Row Product(Agarbatti/Dhoop) will be applicable on 5% GST</h4>
  </div>
</section>
<div class="control-bar">
  <div class="search"><input id="searchInput" placeholder="Search: e.g. Scented, Raw, Dhoop..."></div>
  <select id="categoryFilter" class="select">
    <option value="all">All categories</option>
    <option value="black-scented-agarbatti">Black Scented Agarbatti</option>
    <option value="white-scented-agarbatti">White Scented Agarbatti</option>
    <option value="row-agarbatti">Row Agarbatti</option>
    <option value="scented-dhoop">Scented Dhoop</option>
    <option value="row-dhoop">Row Dhoop</option>
  </select>
</div>
<section id="products" class="products"></section>

<div id="productModal" class="modal">
  <button class="close" onclick="closeModal()">✕</button>
  <div class="modal-content">
    <div class="modal-left"><img id="modalImg" src=""></div>
    <div class="modal-right">
      <h2 id="modalName"></h2>
      <div id="modalPrice" style="font-weight:800;color:var(--accent);margin-bottom:10px;"></div>
      <p id="modalDesc"></p>
      
      <div class="modal-actions">
        <div id="standardOptions">
            <label for="modalWeight" style="font-weight:700;">Choose Weight</label>
            <select id="modalWeight" aria-label="Choose weight"></select>
            <label for="modalSize" style="font-weight:700;">Size (if applicable)</label>
            <select id="modalSize" aria-label="Choose size"></select>
            <label for="modalPackets" style="font-weight:700;">Packets (1 - 100)</label>
            <select id="modalPackets" aria-label="Choose packet quantity"></select>
        </div>

        <div id="rawOptions" style="display:none;">
            <label for="customKgInput" style="font-weight:700;">Enter Quantity (KG)</label>
            <input type="number" id="customKgInput" placeholder="Enter weight in KG (e.g. 5)" min="1" max="500" step="0.5" value="1">
        </div>

        <button id="modalOrder" class="btn btn-order" onclick="openConfirmation()">Next Step</button>
        <button class="btn btn-details" onclick="closeModal()">Close</button>
      </div>
    </div>
  </div>
</div>

<div id="confirmationModal" class="modal" style="z-index: 70;">
    <div class="modal-content confirm-box">
        <h2 style="margin-bottom:5px;">Order Review</h2>
        <p style="color:var(--muted); font-size:14px; margin-bottom:10px;">Please check your order before confirming.</p>
        
        <div id="confirmDetails" class="confirm-details">
            </div>

        <div style="display:flex; gap:10px; width:100%;">
            <button class="btn btn-details" onclick="closeConfirmation()">Edit Order</button>
            <button id="finalConfirmBtn" class="btn btn-order" onclick="finalizeOrder()">Confirm & Send</button>
        </div>
    </div>
</div>

<div id="feedbackModal" class="modal" style="z-index: 80;">
    <button class="close" onclick="closeFeedback()">✕</button>
    <div class="modal-content feedback-box">
        <h2 style="margin-bottom:5px;">How was your experience?</h2>
        <div class="star-rating" id="starContainer">
            <span class="star" data-value="1">★</span><span class="star" data-value="2">★</span><span class="star" data-value="3">★</span><span class="star" data-value="4">★</span><span class="star" data-value="5">★</span>
        </div>
        <textarea id="feedbackText" class="feedback-text" placeholder="Write your feedback here (optional)..."></textarea>
        <button class="feedback-btn" onclick="submitFeedback()">Submit Feedback</button>
    </div>
</div>

<section id="contact" class="contact-bottom">
  <div class="c-box"><h3>Phone</h3><p><a href="tel:+919427631258">+91 9427631258</a></p></div>
  <div class="c-box"><h3>Instagram</h3><p><a href="https://www.instagram.com/tulsienterprise2" target="_blank">@tulsienterprise2</a></p></div>
  <div class="c-box"><h3>Location</h3><p><a href="https://maps.app.goo.gl/5dGsm2WmXb1DmM1L6" target="_blank">View on map</a></p></div>
</section>
</div>

<div class="min-popup">
  <div class="marquee-content">
    "Shipping Charge Applicable On Every Product As Per KM"       |       "Special Offer: Buy 10 Scented Dhoop Stick Box , get 1 Box free"
  </div>
</div>

<script>
// --- SECURITY UTILS ---
function sanitizeInput(str) {
    if(!str) return '';
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
}

let isSubmitting = false;

const productsData = [
  /* BLACK Scented Agarbatti */
  {id:1,name:"Gulab",category:"black-scented-agarbatti",basePrice:{gm100:25,gm200:50,gm500:125,kg1:250},img:"te items/IMG-20251208-WA0053.jpg",sizes:["8inch","9inch"]},
  {id:2,name:"Mogra",category:"black-scented-agarbatti",basePrice:{gm100:25,gm200:50,gm500:125,kg1:250},img:"te items/IMG-20251208-WA0053.jpg",sizes:["8inch","9inch"]},
  {id:3,name:"Tulsi Kapoor",category:"black-scented-agarbatti",basePrice:{gm100:25,gm200:50,gm500:125,kg1:250},img:"te items/IMG-20251208-WA0053.jpg",sizes:["8inch","9inch"]},
  {id:4,name:"Kapoor Gugal",category:"black-scented-agarbatti",basePrice:{gm100:25,gm200:50,gm500:125,kg1:250},img:"te items/IMG-20251208-WA0053.jpg",sizes:["8inch","9inch"]},
  {id:5,name:"Pineapple",category:"black-scented-agarbatti",basePrice:{gm100:25,gm200:50,gm500:125,kg1:250},img:"te items/IMG-20251208-WA0053.jpg",sizes:["8inch","9inch"]},
  {id:6,name:"Chandan",category:"black-scented-agarbatti",basePrice:{gm100:25,gm200:50,gm500:125,kg1:250},img:"te items/IMG-20251208-WA0053.jpg",sizes:["8inch","9inch"]},
  {id:7,name:"Ponds",category:"black-scented-agarbatti",basePrice:{gm100:25,gm200:50,gm500:125,kg1:250},img:"te items/IMG-20251208-WA0053.jpg",sizes:["8inch","9inch"]},
  {id:8,name:"Kevda",category:"black-scented-agarbatti",basePrice:{gm100:25,gm200:50,gm500:125,kg1:250},img:"te items/IMG-20251208-WA0053.jpg",sizes:["8inch","9inch"]},
  {id:9,name:"Woods",category:"black-scented-agarbatti",basePrice:{gm100:25,gm200:50,gm500:125,kg1:250},img:"te items/IMG-20251208-WA0053.jpg",sizes:["8inch","9inch"]},
  {id:10,name:"Panchratna",category:"black-scented-agarbatti",basePrice:{gm100:25,gm200:50,gm500:125,kg1:250},img:"te items/IMG-20251208-WA0053.jpg",sizes:["8inch","9inch"]},
  {id:11,name:"Gulab",category:"white-scented-agarbatti",basePrice:{gm100:30,gm200:60,gm500:150,kg1:280},img:"te items/IMG-20251208-WA0053.jpg",sizes:["8inch","9inch"]},
  {id:12,name:"Mogra",category:"white-scented-agarbatti",basePrice:{gm100:30,gm200:60,gm500:150,kg1:280},img:"te items/IMG-20251208-WA0053.jpg",sizes:["8inch","9inch"]},
  {id:13,name:"Tulsi Kapoor",category:"white-scented-agarbatti",basePrice:{gm100:30,gm200:60,gm500:150,kg1:280},img:"te items/IMG-20251208-WA0053.jpg",sizes:["8inch","9inch"]},
  {id:14,name:"Kapoor Gugal",category:"white-scented-agarbatti",basePrice:{gm100:30,gm200:60,gm500:150,kg1:280},img:"te items/IMG-20251208-WA0053.jpg",sizes:["8inch","9inch"]},
  {id:15,name:"Pineapple",category:"white-scented-agarbatti",basePrice:{gm100:30,gm200:60,gm500:150,kg1:280},img:"te items/IMG-20251208-WA0053.jpg",sizes:["8inch","9inch"]},
  {id:16,name:"Chandan",category:"white-scented-agarbatti",basePrice:{gm100:30,gm200:60,gm500:150,kg1:280},img:"te items/IMG-20251208-WA0053.jpg",sizes:["8inch","9inch"]},
  {id:17,name:"Ponds",category:"white-scented-agarbatti",basePrice:{gm100:30,gm200:60,gm500:150,kg1:280},img:"te items/IMG-20251208-WA0053.jpg",sizes:["8inch","9inch"]},
  {id:18,name:"Kevda",category:"white-scented-agarbatti",basePrice:{gm100:30,gm200:60,gm500:150,kg1:280},img:"te items/IMG-20251208-WA0053.jpg",sizes:["8inch","9inch"]},
  {id:19,name:"Woods",category:"white-scented-agarbatti",basePrice:{gm100:30,gm200:60,gm500:150,kg1:280},img:"te items/IMG-20251208-WA0053.jpg",sizes:["8inch","9inch"]},
  {id:20,name:"Panchratna",category:"white-scented-agarbatti",basePrice:{gm100:30,gm200:60,gm500:150,kg1:280},img:"te items/IMG-20251208-WA0053.jpg",sizes:["8inch","9inch"]},
  {id:21,name:"Black Row Agarbatti",category:"row-agarbatti",basePrice:{kg1:66},img:"te items/IMG-20251208-WA0053.jpg",sizes:["8inch","9inch"]},
  {id:22,name:"White Row Agarbatti",category:"row-agarbatti",basePrice:{kg1:85},img:"te items/IMG-20251208-WA0053.jpg",sizes:["8inch","9inch"]},
  {id:23,name:"Color Agarbatti",category:"row-agarbatti",basePrice:{kg1:90},img:"te items/IMG-20251208-WA0053.jpg",sizes:["8inch","9inch"]},
  {id:24,name:"Gulab",category:"scented-dhoop",basePrice:{gm100:50},img:"te items/IMG-20251208-WA0053.jpg",sizes:["4'6\""]},
  {id:25,name:"Mogra",category:"scented-dhoop",basePrice:{gm100:50},img:"te items/IMG-20251208-WA0053.jpg",sizes:["4'6\""]},
  {id:26,name:"Chandan",category:"scented-dhoop",basePrice:{gm100:50},img:"te items/IMG-20251208-WA0053.jpg",sizes:["4'6\""]},
  {id:27,name:"Pineapple",category:"scented-dhoop",basePrice:{gm100:50},img:"te items/IMG-20251208-WA0053.jpg",sizes:["4'6\""]},
  {id:28,name:"Lavender",category:"scented-dhoop",basePrice:{gm100:50},img:"te items/IMG-20251208-WA0053.jpg",sizes:["4'6\""]},
  {id:29,name:"Tulsi Kapoor",category:"scented-dhoop",basePrice:{gm100:50},img:"te items/IMG-20251208-WA0053.jpg",sizes:["4'6\""]},
  {id:30,name:"Kapoor Gugal",category:"scented-dhoop",basePrice:{gm100:50},img:"te items/IMG-20251208-WA0053.jpg",sizes:["4'6\""]},
  {id:31,name:"Gugal",category:"scented-dhoop",basePrice:{gm100:50},img:"te items/IMG-20251208-WA0053.jpg",sizes:["4'6\""]},
  {id:32,name:"Row Dhoop Stick's",category:"row-dhoop",basePrice:{kg1:75},img:"te items/IMG-20251208-WA0053.jpg",sizes:["3'5\"","4'6\""]}
];

const gstProductIds = [21, 22, 23, 32];
const categoryLabels = {
    'black-scented-agarbatti': 'Black Scented',
    'white-scented-agarbatti': 'White Scented',
    'row-agarbatti': 'Raw Agarbatti',
    'scented-dhoop': 'Scented Dhoop',
    'row-dhoop': 'Raw Dhoop'
};

const productsEl = document.querySelector('.products');
function displayCategoryLabel(c){ return categoryLabels[c] || c; }

/* --- RENDER CARD (UPDATED WITH SEPARATE LINES) --- */
function createProductCard(p){
  const art=document.createElement('article');
  art.className='product';
  art.setAttribute('onclick', `openModal(${p.id})`); 
  
  let displayPrice = 0;
  if(p.category.includes('row')) displayPrice = p.basePrice.kg1;
  else if(p.basePrice.gm100) displayPrice = p.basePrice.gm100;
  
  let priceHtml = '';
  if(gstProductIds.includes(p.id)){
      const gstAmt = displayPrice * 0.05;
      const total = displayPrice + gstAmt;
      priceHtml = `<div class="p-price">₹${displayPrice} + 5% GST <span style="font-size:12px;color:#6b7280;font-weight:400">/KG</span></div>`;
  } else {
      priceHtml = `<div class="p-price">From ₹${displayPrice}</div>`;
  }

  art.innerHTML=`
    <div class="img"><img src="${p.img}" alt="${p.name}" loading="lazy" onerror="this.onerror=null;this.src='https://via.placeholder.com/600x600/f4f6f8/bd1b1b?text=${p.name}'"></div>
    <div class="p-meta">
        <div class="p-name">${p.name}</div>
        ${priceHtml}
        <div class="p-sub">${displayCategoryLabel(p.category)}</div>
    </div>
  `;
  return art;
}
function renderProducts(list){productsEl.innerHTML='';list.forEach(p=>productsEl.appendChild(createProductCard(p)))};
renderProducts(productsData);

/* --- MODAL LOGIC --- */
const modal=document.getElementById('productModal');
const modalImg=document.getElementById('modalImg');
const modalName=document.getElementById('modalName');
const modalPrice=document.getElementById('modalPrice');
const modalDesc=document.getElementById('modalDesc');

const modalWeight=document.getElementById('modalWeight');
const modalSize=document.getElementById('modalSize');
const modalPackets=document.getElementById('modalPackets');
const standardOptions = document.getElementById('standardOptions');
const rawOptions = document.getElementById('rawOptions');
const customKgInput = document.getElementById('customKgInput');

// CONFIRMATION VARS
const confirmationModal = document.getElementById('confirmationModal');
const confirmDetails = document.getElementById('confirmDetails');
let currentOrderMsg = ""; 
let currentProduct = null;

function populatePackets(){modalPackets.innerHTML='';for(let i=1;i<=100;i++){const o=document.createElement('option');o.value=i;o.textContent=`${i} Packet${i>1?'s':''}`;modalPackets.appendChild(o);}}
populatePackets();

function openModal(id){
  const p=productsData.find(x=>x.id===id);
  if(!p) return;
  currentProduct=p;
  modalName.textContent=p.name;
  modalDesc.textContent=p.desc || `Premium quality ${displayCategoryLabel(p.category)}.`;
  modalImg.src=p.img;

  const isRaw = gstProductIds.includes(p.id);
  if(isRaw) {
      standardOptions.style.display = 'none';
      rawOptions.style.display = 'block';
      customKgInput.value = 1; 
  } else {
      standardOptions.style.display = 'block';
      rawOptions.style.display = 'none';
      modalWeight.innerHTML = '';
      if(p.category === 'scented-dhoop') {
          modalWeight.innerHTML = '<option value="100GM">100GM</option>';
      } else {
          modalWeight.innerHTML = `<option value="100GM">100GM</option><option value="200GM">200GM</option><option value="500GM">500GM</option><option value="1KG">1KG</option>`;
      }
      modalPackets.value='1';
      modalSize.innerHTML='';
      const sizes=p.sizes || [];
      if(sizes.length===0) modalSize.innerHTML='<option value="">Standard Size</option>';
      else sizes.forEach(s=>{const o=document.createElement('option');o.value=s; o.textContent=s;modalSize.appendChild(o);});
  }
  updateModalPrice();
  
  modalWeight.onchange=updateModalPrice;
  modalSize.onchange=updateModalPrice;
  modalPackets.onchange=updateModalPrice;
  customKgInput.oninput=updateModalPrice;
  
  modal.classList.add('open');
  document.body.style.overflow='hidden';
}

function updateModalPrice(){
  if(!currentProduct) return;
  const isRaw = gstProductIds.includes(currentProduct.id);

  if (isRaw) {
      const enteredKg = parseFloat(customKgInput.value);
      if(!enteredKg || enteredKg <= 0) {
          modalPrice.textContent = "Please enter valid weight";
          return;
      }
      const ratePerKg = currentProduct.basePrice.kg1;
      const baseTotal = enteredKg * ratePerKg;
      const gstAmount = baseTotal * 0.05;
      const finalTotal = baseTotal + gstAmount;
      modalPrice.innerHTML = `Total: ₹${finalTotal.toFixed(2)} <span style="font-size:13px; color:#6b7280; font-weight:400">(₹${ratePerKg}/kg + 5% GST)</span>`;
  } else {
      const wt=modalWeight.value;
      const packets=Number(modalPackets.value)||1;
      let unitPrice=0;
      if(wt==='100GM') unitPrice=currentProduct.basePrice.gm100;
      else if(wt==='200GM') unitPrice=currentProduct.basePrice.gm200;
      else if(wt==='500GM') unitPrice=currentProduct.basePrice.gm500;
      else if(wt==='1KG') unitPrice=currentProduct.basePrice.kg1;
      const baseTotal=unitPrice*packets;
      modalPrice.textContent=`Total: ₹${baseTotal} (${packets} × ₹${unitPrice})`;
  }
}

function closeModal(){ modal.classList.remove('open'); document.body.style.overflow=''; currentProduct=null; }

/* --- OPEN CONFIRMATION --- */
function openConfirmation() {
    if(!currentProduct) return;
    
    // Security/Validation
    const isRaw = gstProductIds.includes(currentProduct.id);
    if(isRaw) {
        const kg = parseFloat(customKgInput.value);
        if(!kg || kg <= 0 || kg > 1000) { alert("Invalid quantity."); return; }
    } else {
        const pkts = Number(modalPackets.value);
        if(!pkts || pkts <= 0 || pkts > 100) { alert("Invalid packets."); return; }
    }

    const catLabel = displayCategoryLabel(currentProduct.category);
    let summaryHtml = `<div style="margin-bottom:8px; font-weight:700; color:var(--text-muted); font-size:12px; text-transform:uppercase;">${catLabel}</div>`;
    summaryHtml += `<div style="font-size:18px; font-weight:800; margin-bottom:10px;">${currentProduct.name}</div>`;
    
    let whatsappMsg = `*New Order Request*%0A%0A*Category:* ${catLabel}%0A*Item:* ${currentProduct.name}%0A`;

    if (isRaw) {
        const kg = parseFloat(customKgInput.value);
        const rate = currentProduct.basePrice.kg1;
        const total = kg * rate;
        const gst = total * 0.05;
        const final = total + gst;

        summaryHtml += `
            <div style="display:flex; justify-content:space-between; margin-bottom:5px;"><span>Quantity:</span> <strong>${kg} KG</strong></div>
            <div style="display:flex; justify-content:space-between; margin-bottom:5px;"><span>Base Price:</span> <span>₹${total.toFixed(2)}</span></div>
            <div style="display:flex; justify-content:space-between; margin-bottom:5px; padding-bottom:10px; border-bottom:1px solid #e5e7eb;"><span>GST (5%):</span> <span>₹${gst.toFixed(2)}</span></div>
            <div style="display:flex; justify-content:space-between; font-size:18px; color:#991b1b; font-weight:800;"><span>Total:</span> <span>₹${final.toFixed(2)}</span></div>
        `;
        whatsappMsg += `*Quantity:* ${kg} KG%0A*Base Price:* ₹${total.toFixed(2)}%0A*GST (5%):* ₹${gst.toFixed(2)}%0A--------------------%0A*GRAND TOTAL: ₹${final.toFixed(2)}*`;

    } else {
        const wt = modalWeight.value;
        const pkts = modalPackets.value;
        const size = modalSize.value;
        
        let unitPrice=0;
        if(wt==='100GM') unitPrice=currentProduct.basePrice.gm100;
        else if(wt==='200GM') unitPrice=currentProduct.basePrice.gm200;
        else if(wt==='500GM') unitPrice=currentProduct.basePrice.gm500;
        else if(wt==='1KG') unitPrice=currentProduct.basePrice.kg1;
        const total = unitPrice * pkts;

        summaryHtml += `
            <div style="display:flex; justify-content:space-between; margin-bottom:5px;"><span>Variant:</span> <strong>${wt} ${size?`(${size})`:''}</strong></div>
            <div style="display:flex; justify-content:space-between; margin-bottom:5px; padding-bottom:10px; border-bottom:1px solid #e5e7eb;"><span>Packets:</span> <strong>${pkts}</strong></div>
            <div style="display:flex; justify-content:space-between; font-size:18px; color:#991b1b; font-weight:800;"><span>Total:</span> <span>₹${total}</span></div>
        `;
        whatsappMsg += `*Weight:* ${wt} ${size ? '('+size+')' : ''}%0A*Packets:* ${pkts}%0A--------------------%0A*GRAND TOTAL: ₹${total}*`;
    }

    confirmDetails.innerHTML = summaryHtml;
    currentOrderMsg = whatsappMsg;

    modal.classList.remove('open');
    confirmationModal.classList.add('open');
}

function closeConfirmation() { confirmationModal.classList.remove('open'); modal.classList.add('open'); }

/* --- FINALIZE --- */
function finalizeOrder() {
    if (isSubmitting) return;
    isSubmitting = true;
    
    const btn = document.getElementById('finalConfirmBtn');
    const originalText = btn.textContent;
    btn.textContent = "Opening WhatsApp...";
    btn.style.opacity = "0.7";

    window.open('https://wa.me/919427631258?text='+currentOrderMsg, '_blank');

    setTimeout(() => {
        isSubmitting = false;
        btn.textContent = originalText;
        btn.style.opacity = "1";
        confirmationModal.classList.remove('open');
        feedbackModal.classList.add('open');
    }, 2000);
}

/* --- FEEDBACK --- */
const feedbackModal = document.getElementById('feedbackModal');
const stars = document.querySelectorAll('.star');
let selectedRating = 0;

function closeFeedback() { feedbackModal.classList.remove('open'); document.body.style.overflow = ''; }
stars.forEach(star => { star.addEventListener('click', function() { selectedRating = this.getAttribute('data-value'); updateStars(selectedRating); }); });
function updateStars(rating) { stars.forEach(s => { if(s.getAttribute('data-value') <= rating) s.classList.add('active'); else s.classList.remove('active'); }); }
function submitFeedback() {
    if(selectedRating === 0) { alert("Please tap a star to rate!"); return; }
    alert(`Thank you for your ${selectedRating}-star rating!`);
    selectedRating = 0; document.getElementById('feedbackText').value = ""; updateStars(0); closeFeedback();
}

/* --- SEARCH & CHIP FILTER --- */
const searchInput=document.getElementById('searchInput'); const categoryFilter=document.getElementById('categoryFilter');
searchInput.addEventListener('input',applyFilters);categoryFilter.addEventListener('change',applyFilters);
function applyFilters(){
  const q=sanitizeInput(searchInput.value.toLowerCase().trim());
  const cat=categoryFilter.value;
  
  const filtered=productsData.filter(p=>{
    const matchCat=(cat==='all')||(p.category===cat);
    const nameMatch=p.name.toLowerCase().includes(q);
    return matchCat && (q==='' || nameMatch || displayCategoryLabel(p.category).toLowerCase().includes(q));
  });
  renderProducts(filtered);
} 

function quickFilter(catValue) {
    categoryFilter.value = catValue;
    applyFilters();
    const productsSection = document.getElementById('products');
    productsSection.scrollIntoView({ behavior: 'smooth' });
}

// Global Close on Escape
document.addEventListener('keydown',e=>{if(e.key==='Escape') {closeModal(); closeConfirmation(); closeFeedback();}});
</script>
</body>
</html>